<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Blixor AI</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

<style>
* {
  font-family: 'Roboto', sans-serif !important;
}

body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #e5ddd5;
}

body.dark {
  background: #121212;
  color: #e0e0e0;
}

#welcome-text {
  font-size: 28px;
  margin: 20px;
  text-align: left;
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 18px;
}

.user {
  align-self: flex-end;
  background: #dcf8c6;
  border-bottom-right-radius: 4px;
}

.ai {
  align-self: flex-start;
  background: #ffffff;
  border-bottom-left-radius: 4px;
}

body.dark .user { background: #1f1f1f; color: white; }
body.dark .ai { background: #1e1e1e; color: white; }

#input-bar {
  display: flex;
  gap: 6px;
  padding: 10px;
  background: #f0f0f0;
}

body.dark #input-bar {
  background: #1a1a1a;
}

select, input, button {
  border-radius: 20px;
  padding: 10px;
  border: none;
}

input {
  flex: 1;
}

button {
  background: #075e54;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="welcome-text">What would you like to talk about?</div>
<div id="chat"></div>

<div id="input-bar">
  <select id="ai-select">
    <option value="blixor">Blixor AI (Wikipedia + Math)</option>
    <option value="llama">LLaMA 1B (WebLLM)</option>
  </select>
  <input id="input" placeholder="Type your message..." />
  <button id="send">Send</button>
  <button id="dark">ðŸŒ™</button>
</div>

<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const welcome = document.getElementById("welcome-text");

let engine = null;

/* ================= PROMPTS ================= */
const SYSTEM_PROMPT = `
You are Blixor AI.
You explain things simply and clearly.
Never mention models, LLaMA, or WebLLM.
`;

/* ================= HELPERS ================= */
function addMessage(text, cls) {
  welcome.style.display = "none";
  const div = document.createElement("div");
  div.className = "message " + cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

/* ====== SMART MATH DETECTOR ====== */
function isMath(text) {
  return /[\d\+\-\*\/\^\(\)=]/.test(text) && !/[a-zA-Z]/.test(text);
}

function solveMath(text) {
  try {
    return eval(text.replace(/\^/g, "**"));
  } catch {
    return null;
  }
}

/* ====== CLEAN WIKIPEDIA QUERY ====== */
function extractTopic(text) {
  return text
    .toLowerCase()
    .replace(/what is|what are|who is|tell me about|explain|define|give me|show me|information about/gi, "")
    .replace(/\?/g, "")
    .trim();
}

async function fetchWiki(topic) {
  try {
    const res = await fetch(
      `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`
    );
    const data = await res.json();
    return data.extract;
  } catch {
    return null;
  }
}

/* ================= WEBLLM ================= */
async function loadLlama() {
  if (engine) return engine;
  engine = await webllm.CreateMLCEngine("tinyllama-1.1b-chat");
  return engine;
}

async function askLlama(prompt) {
  if (!engine) await loadLlama();
  const reply = await engine.chat.completions.create({
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: prompt }
    ]
  });
  return reply.choices[0].message.content;
}

/* ================= MAIN ================= */
async function send() {
  const text = input.value.trim();
  if (!text) return;

  const type = document.getElementById("ai-select").value;
  input.value = "";

  addMessage(text, "user");

  if (type === "blixor") {
    if (isMath(text)) {
      const result = solveMath(text);
      addMessage("Answer: " + result, "ai");
      return;
    }

    const topic = extractTopic(text);
    const wiki = await fetchWiki(topic);

    if (wiki) addMessage(wiki, "ai");
    else addMessage("I couldn't find that topic.", "ai");
    return;
  }

  // LLaMA
  const loading = addMessage("Loading Answer", "ai");
  const answer = await askLlama(text);
  loading.textContent = answer;
}

/* ================= EVENTS ================= */
document.getElementById("send").onclick = send;
input.addEventListener("keydown", e => e.key === "Enter" && send());
document.getElementById("dark").onclick = () =>
  document.body.classList.toggle("dark");
</script>

</body>
</html>
